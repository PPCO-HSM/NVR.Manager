<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NVR Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">NVR Manager</a>
      <div class="d-flex align-items-center ms-auto">
        <div id="device-type-stats" class="text-white me-3 small"></div>
        <a href="pcs.html" class="btn btn-info me-2">🖥️ AnyDesk Devices</a>
        <button id="logout-btn" class="btn btn-danger">تسجيل خروج</button>
      </div>
    </div>
  </nav>  <div class="container my-4">
    <h2 class="mb-3">إدارة بيانات الأجهزة</h2>
    <div class="mb-3">
      <input type="text" id="search-input" class="form-control" placeholder="ابحث هنا في الأجهزة..." />
    </div>
    <form id="device-form" class="mb-4">
      <input type="hidden" id="doc-id" />
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" id="site-location" placeholder="Site Location" required />
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="device-name" placeholder="Device Name" required />
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="username" placeholder="Username" required />
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="password" placeholder="Password" required />
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="verification-code" placeholder="Verification Code" />
        </div>
        <div class="col-md-4">
          <input type="number" class="form-control" id="port-nvr" placeholder="Port NVR" />
        </div>
        <div class="col-md-4">
          <input type="number" class="form-control" id="used-ports" placeholder="Used Ports" />
        </div>
        <div class="col-md-4">
          <select class="form-select" id="device-type" required>
            <option value="" disabled selected>Device Type</option>
            <option value="NVR">NVR</option>
            <option value="Camera">Camera</option>
            <option value="Switch">Switch</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-success mt-3" id="submit-btn">إضافة جهاز</button>
      <button type="button" class="btn btn-secondary mt-3 d-none" id="cancel-edit-btn">إلغاء التعديل</button>
    </form><table class="table table-striped" id="devices-table">
  <thead>
    <tr>
      <th>Site Location</th>
      <th>Device Name</th>
      <th>Username</th>
      <th>Password</th>
      <th>Verification Code</th>
      <th>Port NVR</th>
      <th>Used Ports</th>
      <th>Available</th>
      <th>Device Type</th>
      <th>عمليات</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="export-btn" class="btn btn-primary">تصدير Excel</button>

  </div>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4wU3IYIImaBQEfDmNibN7DiDZIkfezdg",
      authDomain: "nvr-manager.firebaseapp.com",
      projectId: "nvr-manager",
      storageBucket: "nvr-manager.firebasestorage.app",
      messagingSenderId: "932622815202",
      appId: "1:932622815202:web:f50ffafb4f6584278fb3bb",
      measurementId: "G-GGS0SZCMD2"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = 'login.html';
    });
    document.getElementById('logout-btn').onclick = () => auth.signOut();

    const form = document.getElementById('device-form');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    let editDocId = null;

    function countItems(data, type) {
      return data.filter(d => d.deviceType && d.deviceType.toLowerCase() === type.toLowerCase()).length;
    }

    document.getElementById('export-btn').onclick = () => {
      db.collection('devices').get().then(snapshot => {
        const devices = [];
        snapshot.forEach(doc => devices.push(doc.data()));

        const summary = [
          ["Summary"],
          ["Total NVRs", countItems(devices, "NVR")],
          ["Total Cameras", countItems(devices, "Camera")],
          ["Total Switches", countItems(devices, "Switch")],
          [],
          ["Exported At", new Date().toLocaleString()]
        ];

        const tableData = devices.map(d => ({
          "Site Location": d.siteLocation,
          "Device Name": d.deviceName,
          "Username": d.username,
          "Password": d.password,
          "Verification Code": d.verificationCode || '',
          "Port NVR": d.portNVR || '',
          "Used Ports": d.usedPorts || '',
          "Available": (Number(d.portNVR || 0) - Number(d.usedPorts || 0)),
          "Device Type": d.deviceType
        }));

        const wb = XLSX.utils.book_new();
        const summarySheet = XLSX.utils.aoa_to_sheet(summary);
        XLSX.utils.book_append_sheet(wb, summarySheet, "Summary");
        const dataSheet = XLSX.utils.json_to_sheet(tableData);
        XLSX.utils.book_append_sheet(wb, dataSheet, "Devices");
        XLSX.writeFile(wb, "devices_export.xlsx");
      });
    };
  </script></body>
</html>
