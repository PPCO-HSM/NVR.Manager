<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PPCO-AnyDesk Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      background-color: #f5f7fa;
      font-family: 'Cairo', sans-serif;
    }
    .btn {
      border-radius: 8px;
      font-weight: 600;
    }
    .navbar {
      background: linear-gradient(to right, #0059b3, #007bff);
    }
    .navbar-brand {
      font-weight: bold;
      color: #fff !important;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar-brand img {
      height: 45px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <img src="https://ppco-ksa.com/wp-content/uploads/2023/05/cropped-Untitled-design-1-1.png" alt="Logo" style="height: 75px;" />
      </a>
      <div>
        <a href="main.html" class="btn btn-light text-dark me-2">ğŸ  NVR Manager</a>
        <button id="logout-btn" class="btn btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </nav>
  

  <div class="container my-4">
    <h2 class="mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¬Ù‡Ø²Ø© AnyDesk</h2>
    <div class="mb-3">
      <input type="text" id="search-input" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§..." />
    </div>
    <form id="pc-form" class="mb-4">
      <input type="hidden" id="doc-id" />
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" id="site-location" placeholder="Site Location" required />
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="device-name" placeholder="Device Name" required />
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="anydesk-id" placeholder="AnyDesk ID" required />
        </div>
        <div class="col-md-4">
          <input type="password" class="form-control" id="password" placeholder="Password" required />
        </div>
        <div class="col-md-8">
          <input type="text" class="form-control" id="notes" placeholder="Notes" />
        </div>
      </div>
      <button type="submit" class="btn btn-success mt-3" id="submit-btn">Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø²</button>
      <button type="button" class="btn btn-secondary mt-3 d-none" id="cancel-edit-btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </form>

    <table class="table table-striped" id="pcs-table">
      <thead>
        <tr>
          <th>Site Location</th>
          <th>Device Name</th>
          <th>AnyDesk ID</th>
          <th>Password</th>
          <th>Notes</th>
          <th>Ø¹Ù…Ù„ÙŠØ§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="export-btn" class="btn btn-primary">ØªØµØ¯ÙŠØ± Excel</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- SheetJS (Excel export) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4wU3IYIImaBQEfDmNibN7DiDZIkfezdg",
      authDomain: "nvr-manager.firebaseapp.com",
      projectId: "nvr-manager",
      storageBucket: "nvr-manager.firebasestorage.app",
      messagingSenderId: "932622815202",
      appId: "1:932622815202:web:f50ffafb4f6584278fb3bb",
      measurementId: "G-GGS0SZCMD2"
    };
    firebase.initializeApp(firebaseConfig);
  
    const auth = firebase.auth();
    const db = firebase.firestore();
  
    let isAdmin = false;
  
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
      } else {
        const adminEmails = ["it@ppco-ksa.com", "it.assistant3@ppco-ksa.com"];
        isAdmin = adminEmails.includes(user.email);
    
        if (!isAdmin) {
          const form = document.getElementById('pc-form');
          if (form) form.remove();
    
          const exportBtn = document.getElementById('export-btn');
          if (exportBtn) exportBtn.remove();
    
          // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
          const table = document.getElementById('pcs-table');
          if (table) {
            for (let row of table.rows) {
              if (row.cells[3]) row.cells[3].style.display = 'none'; // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
            }
          }
        }
    
        loadPCs();
      }
    });
    
  
    document.getElementById('logout-btn').onclick = () => auth.signOut();
  
    const form = document.getElementById('pc-form');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    let editDocId = null;
  
    function loadPCs() {
      const tbody = document.querySelector('#pcs-table tbody');
      tbody.innerHTML = '';
  
      db.collection('anydesk_devices').get().then(snapshot => {
        snapshot.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement('tr');
  
          tr.innerHTML = `
            <td>${d.siteLocation}</td>
            <td>${d.deviceName}</td>
            <td>${d.anydeskId}</td>
            <td ${!isAdmin ? 'style="display:none;"' : ''}>${d.password || ''}</td>
            <td>${d.notes || ''}</td>
            <td>
              ${isAdmin ? `
                <button class="btn btn-sm btn-warning edit-btn" data-id="${doc.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${doc.id}">Ø­Ø°Ù</button>
              ` : ''}
              <button class="btn btn-sm btn-success connect-btn" data-anydeskid="${d.anydeskId}">Ø§ØªØµØ§Ù„</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
  
        if (isAdmin) {
          document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = () => {
              const id = btn.getAttribute('data-id');
              db.collection('anydesk_devices').doc(id).get().then(doc => {
                const d = doc.data();
                document.getElementById('doc-id').value = id;
                form['site-location'].value = d.siteLocation;
                form['device-name'].value = d.deviceName;
                form['anydesk-id'].value = d.anydeskId;
                form['password'].value = d.password || '';
                form['notes'].value = d.notes || '';
                submitBtn.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù‡Ø§Ø²';
                cancelEditBtn.classList.remove('d-none');
                editDocId = id;
              });
            };
          });
  
          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = () => {
              if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')) {
                db.collection('anydesk_devices').doc(btn.getAttribute('data-id')).delete().then(loadPCs);
              }
            };
          });
        }
  
        document.querySelectorAll('.connect-btn').forEach(btn => {
          btn.onclick = () => {
            const anydeskId = btn.getAttribute('data-anydeskid');
            window.open(`anydesk://${anydeskId}`, '_blank');
          };
        });
      });
    }
  
    form?.addEventListener('submit', e => {
      e.preventDefault();
  
      const data = {
        siteLocation: form['site-location'].value,
        deviceName: form['device-name'].value,
        anydeskId: form['anydesk-id'].value,
        password: form['password'].value,
        notes: form['notes'].value,
      };
  
      const ref = editDocId
        ? db.collection('anydesk_devices').doc(editDocId).set(data)
        : db.collection('anydesk_devices').add(data);
  
      ref.then(() => {
        alert(editDocId ? 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        form.reset();
        submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø²';
        cancelEditBtn.classList.add('d-none');
        editDocId = null;
        loadPCs();
      });
    });
  
    cancelEditBtn.onclick = () => {
      form.reset();
      submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø²';
      cancelEditBtn.classList.add('d-none');
      editDocId = null;
    };
  
    document.getElementById('export-btn')?.addEventListener('click', () => {
      db.collection('anydesk_devices').get().then(snapshot => {
        const data = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          data.push({
            "Site Location": d.siteLocation,
            "Device Name": d.deviceName,
            "AnyDesk ID": d.anydeskId,
            "Password": d.password || '',
            "Notes": d.notes || '',
          });
        });
  
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "AnyDesk Devices");
        XLSX.writeFile(workbook, "anydesk_devices.xlsx");
      });
    });
  
    // Ø¨Ø­Ø«
    document.getElementById('search-input')?.addEventListener('input', function () {
      const query = this.value.toLowerCase();
      document.querySelectorAll('#pcs-table tbody tr').forEach(row => {
        const cellsText = Array.from(row.cells).slice(0, 5).map(td => td.textContent.toLowerCase()).join(' ');
        row.style.display = cellsText.includes(query) ? '' : 'none';
      });
    });
  </script>
  
</body>
</html>
